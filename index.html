<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stedskart ‚Äî Lag vakre kartplakater av dine favorittplasser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=JetBrains+Mono:wght@400;500&family=Bebas+Neue&family=Oswald:wght@400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Montserrat:wght@400;500;600;700;800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Raleway:wght@400;500;600;700;800&family=Abril+Fatface&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #18181f;
            --bg-elevated: #1f1f28;
            --border: #2a2a35;
            --border-hover: #3a3a48;
            --text-primary: #f5f5f7;
            --text-secondary: #8e8e93;
            --text-muted: #636366;
            --accent: #c9a962;
            --accent-hover: #d4b872;
            --accent-glow: rgba(201, 169, 98, 0.15);
            --success: #34c759;
            --danger: #ff453a;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.5);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ambient background */
        .ambient-bg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(201, 169, 98, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(120, 100, 180, 0.06) 0%, transparent 50%);
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 32px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 18px;
            background: linear-gradient(180deg, rgba(201, 169, 98, 0.08) 0%, transparent 100%);
        }

        .logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent) 0%, #d4b872 50%, #8b7355 100%);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(201, 169, 98, 0.3);
        }

        .logo-text-wrapper {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .logo-text {
            font-weight: 800;
            font-size: 30px;
            letter-spacing: -0.5px;
            line-height: 1.1;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-tagline {
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
            font-style: italic;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Scrollbar */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        /* Section */
        .section {
            margin-bottom: 28px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .section-badge {
            font-size: 11px;
            padding: 4px 10px;
            background: var(--accent-glow);
            color: var(--accent);
            border-radius: 100px;
            font-weight: 500;
        }

        /* Input styles */
        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: var(--transition);
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input::placeholder {
            color: var(--text-muted);
        }

        .input-icon-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .input-icon-wrapper .input {
            padding-left: 42px;
        }

        /* Search results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-top: 4px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-md);
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 14px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-elevated);
        }

        .search-result-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .search-result-region {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Quick location buttons */
        .quick-locations {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .quick-loc-btn {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-loc-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Style cards */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .style-card {
            position: relative;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
            cursor: pointer;
            transition: var(--transition);
            overflow: hidden;
        }

        .style-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .style-card.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .style-preview {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .style-color {
            flex: 1;
            height: 32px;
            border-radius: 6px;
        }

        .style-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .style-desc {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .style-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.5);
            transition: var(--transition);
        }

        .style-card.active .style-check {
            opacity: 1;
            transform: scale(1);
        }

        /* Perspective buttons */
        .perspective-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .perspective-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 8px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .perspective-btn:hover {
            border-color: var(--border-hover);
        }

        .perspective-btn.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .perspective-icon {
            font-size: 20px;
            margin-bottom: 6px;
        }

        .perspective-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 16px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .slider-value {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            background: var(--accent-glow);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-elevated);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(201, 169, 98, 0.3);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Color picker */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .color-swatch {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.active {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--bg-primary);
        }

        .custom-color-wrapper {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .color-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px 12px;
        }

        .color-picker {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
        }

        .color-hex {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            outline: none;
            text-transform: uppercase;
        }

        /* Font selector */
        .font-grid {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .font-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 14px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .font-btn:hover {
            border-color: var(--border-hover);
            background: var(--bg-elevated);
        }

        .font-btn.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .font-preview {
            font-size: 18px;
            color: var(--text-primary);
            letter-spacing: 0.05em;
        }

        .font-name {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif !important;
        }

        .font-btn.active .font-name {
            color: var(--accent);
        }

        /* Frame selector */
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .frame-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 6px 8px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .frame-btn:hover {
            border-color: var(--border-hover);
        }

        .frame-btn.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .frame-preview {
            width: 36px;
            height: 48px;
            background: var(--bg-elevated);
            border-radius: 3px;
            padding: 4px;
        }

        .frame-preview-inner {
            width: 100%;
            height: 100%;
            border-radius: 2px;
        }

        .frame-btn span {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .frame-btn.active span {
            color: var(--accent);
        }

        /* Toggle switch */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-info {
            flex: 1;
        }

        .toggle-label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .toggle-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-elevated);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background: var(--accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Export section (inside scroll area) */
        .export-section {
            padding: 0;
            background: transparent;
            margin-top: 8px;
        }

        .export-quality {
            margin-bottom: 16px;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .quality-btn {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 8px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .quality-btn:hover {
            border-color: var(--border-hover);
        }

        .quality-btn.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .quality-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .quality-btn.active .quality-name {
            color: var(--accent);
        }

        .quality-size {
            font-size: 9px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .toggle-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .text-input {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: var(--transition);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        .export-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--accent), #8b7355);
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-primary);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(201, 169, 98, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .export-btn.secondary:hover {
            background: var(--border);
            box-shadow: var(--shadow-md);
        }

        .export-info {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }

        .keyboard-hints {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .hint {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-muted);
        }

        kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            color: var(--text-secondary);
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-brand {
            font-size: 13px;
            color: var(--accent);
        }

        .footer-brand a {
            color: var(--accent);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-brand a:hover {
            color: var(--accent-hover);
        }

        .footer-shortcuts {
            display: flex;
            gap: 8px;
        }

        /* Main canvas area */
        .canvas-area {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: 
                linear-gradient(90deg, var(--border) 1px, transparent 1px),
                linear-gradient(var(--border) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        /* Toolbar */
        .canvas-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }

        .toolbar-btn {
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--accent-glow);
            color: var(--accent);
        }

        .toolbar-divider {
            width: 1px;
            background: var(--border);
            margin: 4px 4px;
        }

        /* Poster frame */
        .poster-container {
            position: relative;
            filter: drop-shadow(0 32px 64px rgba(0,0,0,0.5));
        }

        .poster-frame {
            position: relative;
            width: 400px;
            aspect-ratio: 2/3;
            background: #f5f5f0;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .poster-frame.landscape {
            aspect-ratio: 3/2;
            width: 550px;
        }

        .poster-frame.square {
            aspect-ratio: 1/1;
            width: 450px;
        }

        /* Frame styles */
        .poster-inner {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        /* Thin frame - inner border with margin */
        .poster-frame.frame-thin .poster-inner {
            inset: 16px;
        }
        
        .poster-frame.frame-thin .poster-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 2px solid var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1001;
        }

        /* Thick frame - larger margin and border */
        .poster-frame.frame-thick .poster-inner {
            inset: 24px;
        }
        
        .poster-frame.frame-thick .poster-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 4px solid var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1001;
        }

        /* Double frame - margin with double border */
        .poster-frame.frame-double .poster-inner {
            inset: 20px;
        }
        
        .poster-frame.frame-double .poster-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 4px double var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1001;
        }

        /* Vintage frame - margin with textured effect */
        .poster-frame.frame-vintage .poster-inner {
            inset: 28px;
        }
        
        .poster-frame.frame-vintage .poster-inner::before {
            content: '';
            position: absolute;
            inset: 0;
            border: 3px solid var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1001;
        }

        .poster-frame.frame-vintage .poster-inner::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.04) 2px, rgba(0,0,0,0.04) 3px),
                repeating-linear-gradient(-45deg, transparent, transparent 3px, rgba(0,0,0,0.03) 3px, rgba(0,0,0,0.03) 4px);
            background-size: 20px 20px, 25px 25px;
            pointer-events: none;
            z-index: 1002;
        }

        /* Ornate frame - margin with decorative border */
        .poster-frame.frame-ornate .poster-inner {
            inset: 32px;
        }
        
        .poster-frame.frame-ornate .poster-inner::before {
            content: '';
            position: absolute;
            inset: 0;
            border: 3px solid var(--frame-color, #2C2C2C);
            box-shadow: 
                0 0 0 6px var(--bg-color, #f5f5f0),
                0 0 0 8px var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1001;
        }

        /* Corner decorations for ornate */
        .poster-frame.frame-ornate .corner-decor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--frame-color, #2C2C2C);
            pointer-events: none;
            z-index: 1003;
        }

        .poster-frame.frame-ornate .corner-decor.top-left {
            top: 24px;
            left: 24px;
            border-right: none;
            border-bottom: none;
        }

        .poster-frame.frame-ornate .corner-decor.top-right {
            top: 24px;
            right: 24px;
            border-left: none;
            border-bottom: none;
        }

        .poster-frame.frame-ornate .corner-decor.bottom-left {
            bottom: 24px;
            left: 24px;
            border-right: none;
            border-top: none;
        }

        .poster-frame.frame-ornate .corner-decor.bottom-right {
            bottom: 24px;
            right: 24px;
            border-left: none;
            border-top: none;
        }

        /* Map container - now fills entire frame */
        .map-wrapper {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        /* Vintage map effect overlay */
        .map-wrapper.vintage-map::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 500;
            background: 
                /* Krakelering/sprekker - gammelt kart effekt */
                repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(40, 30, 20, 0.03) 3px, rgba(40, 30, 20, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 3px, rgba(40, 30, 20, 0.03) 3px, rgba(40, 30, 20, 0.03) 4px),
                repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(40, 30, 20, 0.02) 8px, rgba(40, 30, 20, 0.02) 10px),
                repeating-linear-gradient(-45deg, transparent, transparent 8px, rgba(40, 30, 20, 0.02) 8px, rgba(40, 30, 20, 0.02) 10px),
                /* Generell patina og slitasje */
                radial-gradient(ellipse at 30% 20%, rgba(80, 60, 40, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, rgba(60, 50, 30, 0.06) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(50, 40, 30, 0.04) 70%),
                /* Sepia-aktig tone */
                linear-gradient(135deg, rgba(139, 119, 101, 0.08) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .map-wrapper.vintage-map::before {
            opacity: 1;
        }

        /* Hvit gl√∏d-effekt overlay */
        .map-glow-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 400;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: radial-gradient(
                ellipse at center,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0) 40%,
                rgba(255, 255, 255, 0.3) 70%,
                rgba(255, 255, 255, 0.6) 90%,
                rgba(255, 255, 255, 0.8) 100%
            );
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Vintage map sepia filter */
        .vintage-map #map {
            filter: sepia(0.15) contrast(0.95) brightness(1.05);
        }

        .leaflet-control-attribution,
        .leaflet-control-zoom {
            display: none !important;
        }

        /* Map label styling */
        #map {
            --label-size: 100%;
            --label-color: #000000;
            --label-shadow: 2px;
        }

        .leaflet-tile-pane {
            filter: var(--map-label-filter, none);
        }

        /* Custom label overlay styling - increases contrast */
        .map-wrapper::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: var(--label-blend-mode, normal);
            background: var(--label-overlay-color, transparent);
            opacity: var(--label-overlay-opacity, 0);
        }

        /* Text overlay - now on top of map */
        .poster-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1050;
        }

        .poster-text {
            position: absolute;
            left: 50%;
            top: 85%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px 40px;
            border-radius: 0;
            z-index: 1100; /* Above frame borders */
        }

        .poster-title {
            font-family: 'Playfair Display', serif;
            font-size: 38px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            line-height: 1.1;
            margin-bottom: 10px;
        }

        .poster-subtitle-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            margin-bottom: 6px;
        }

        .poster-line {
            width: 36px;
            height: 1.5px;
            opacity: 0.5;
        }

        .poster-subtitle {
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .poster-coords {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.1em;
            opacity: 0.7;
        }

        .poster-date {
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0.85;
            margin-top: 10px;
        }

        /* Text Theme: Gradient */
        .poster-overlay.theme-gradient::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--theme-size, 30%);
            background: linear-gradient(to bottom, transparent 0%, var(--theme-color, #ffffff) 100%);
            pointer-events: none;
        }
        
        .poster-overlay.theme-gradient .poster-text {
            color: var(--theme-text-color, #2C2C2C);
        }

        /* Text Theme: Box */
        .poster-overlay.theme-box .poster-text {
            background: var(--theme-color, #ffffff);
            border: 2px solid var(--theme-border-color, #2C2C2C);
            padding: 24px 48px;
            color: var(--theme-text-color, #2C2C2C);
        }
        
        .poster-overlay.theme-box .poster-line {
            background-color: var(--theme-text-color, #2C2C2C) !important;
        }

        /* Text Theme: Panel */
        .poster-overlay.theme-panel::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--theme-size, 25%);
            background: var(--theme-color, #ffffff);
            border-top: 2px solid var(--theme-border-color, #2C2C2C);
            pointer-events: none;
        }
        
        .poster-overlay.theme-panel .poster-text {
            color: var(--theme-text-color, #2C2C2C);
        }
        
        .poster-overlay.theme-panel .poster-line {
            background-color: var(--theme-text-color, #2C2C2C) !important;
        }

        /* Text Theme: Double Line Panel */
        .poster-overlay.theme-double::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--theme-size, 28%);
            background: var(--theme-color, #ffffff);
            border-top: 3px solid var(--theme-border-color, #2C2C2C);
            pointer-events: none;
        }
        
        .poster-overlay.theme-double::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: calc(var(--theme-size, 28%) - 3%);
            border-top: 1px solid var(--theme-border-color, #2C2C2C);
            pointer-events: none;
        }
        
        .poster-overlay.theme-double .poster-text {
            color: var(--theme-text-color, #2C2C2C);
        }
        
        .poster-overlay.theme-double .poster-line {
            background-color: var(--theme-text-color, #2C2C2C) !important;
        }

        /* Loading state */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .poster-frame {
                width: 340px;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                height: auto;
                max-height: 50vh;
            }
            
            .canvas-area {
                min-height: 60vh;
            }
            
            .poster-frame {
                width: min(90%, 360px);
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(20px); }
        }

        .section {
            animation: fadeIn 0.4s ease-out backwards;
        }

        .section:nth-child(1) { animation-delay: 0.05s; }
        .section:nth-child(2) { animation-delay: 0.1s; }
        .section:nth-child(3) { animation-delay: 0.15s; }
        .section:nth-child(4) { animation-delay: 0.2s; }
        .section:nth-child(5) { animation-delay: 0.25s; }
        .section:nth-child(6) { animation-delay: 0.3s; }
        .section:nth-child(7) { animation-delay: 0.35s; }
        .section:nth-child(8) { animation-delay: 0.4s; }
        .section:nth-child(9) { animation-delay: 0.45s; }
        .section:nth-child(10) { animation-delay: 0.5s; }

        /* Info Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            max-width: 560px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h2 svg {
            color: var(--accent);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .modal-body {
            padding: 28px;
        }

        .modal-section {
            margin-bottom: 28px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-section h3 svg {
            color: var(--accent);
            width: 18px;
            height: 18px;
        }

        .modal-section p {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .modal-section ul {
            list-style: none;
            margin-top: 12px;
        }

        .modal-section ul li {
            color: var(--text-secondary);
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.95rem;
        }

        .modal-section ul li::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            margin-top: 8px;
            flex-shrink: 0;
        }

        .keyboard-shortcut {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 3px 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .about-creator {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        .creator-logo {
            width: 100px;
            height: auto;
            max-height: 72px;
            border-radius: var(--radius-md);
            object-fit: contain;
            border: 2px solid var(--border);
            flex-shrink: 0;
            background: var(--bg-card);
            padding: 8px;
        }

        .creator-info h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .creator-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .creator-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .creator-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .creator-link:hover {
            color: var(--accent-hover);
        }

        .creator-link svg {
            width: 14px;
            height: 14px;
        }

        .info-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #d4b872 100%);
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 100;
            box-shadow: 0 4px 20px rgba(201, 169, 98, 0.4);
        }

        .info-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(201, 169, 98, 0.6);
        }

        .info-btn svg {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="ambient-bg"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                </div>
                <div class="logo-text-wrapper">
                    <span class="logo-text">Stedskart</span>
                    <span class="logo-tagline">Ditt sted, din kunst</span>
                </div>
            </header>
            
            <div class="sidebar-content">
                <!-- Location Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üìç Lokasjon</span>
                        <button class="section-badge" onclick="randomLocation()">üé≤ Tilfeldig</button>
                    </div>
                    <div class="input-group">
                        <div class="input-icon-wrapper" style="position: relative;">
                            <svg class="input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <input type="text" class="input" id="searchInput" placeholder="S√∏k etter by eller sted..." autocomplete="off">
                            <div class="search-results" id="searchResults"></div>
                        </div>
                    </div>
                    
                    <!-- Quick presets for popular Norwegian cities -->
                    <div class="quick-locations">
                        <button class="quick-loc-btn" onclick="selectLocation(59.9139, 10.7522, 'Oslo')">Oslo</button>
                        <button class="quick-loc-btn" onclick="selectLocation(60.3913, 5.3221, 'Bergen')">Bergen</button>
                        <button class="quick-loc-btn" onclick="selectLocation(63.4305, 10.3951, 'Trondheim')">Trondheim</button>
                        <button class="quick-loc-btn" onclick="selectLocation(69.6496, 18.9560, 'Troms√∏')">Troms√∏</button>
                        <button class="quick-loc-btn" onclick="selectLocation(68.2000, 14.0000, 'Lofoten')">Lofoten</button>
                    </div>
                </div>

                <!-- Style Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üé® Kartstil</span>
                        <span class="section-badge">11 stiler</span>
                    </div>
                    <div class="style-grid" id="styleGrid">
                        <!-- Styles injected by JS -->
                    </div>
                </div>

                <!-- Perspective Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üî≠ Perspektiv</span>
                    </div>
                    <div class="perspective-grid">
                        <button class="perspective-btn active" data-aspect="portrait" onclick="setAspect('portrait')">
                            <div class="perspective-icon">üì±</div>
                            <div class="perspective-label">Portrett</div>
                        </button>
                        <button class="perspective-btn" data-aspect="landscape" onclick="setAspect('landscape')">
                            <div class="perspective-icon">üñ•Ô∏è</div>
                            <div class="perspective-label">Landskap</div>
                        </button>
                        <button class="perspective-btn" data-aspect="square" onclick="setAspect('square')">
                            <div class="perspective-icon">‚¨ú</div>
                            <div class="perspective-label">Kvadrat</div>
                        </button>
                    </div>
                </div>

                <!-- Zoom & Details -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">‚öôÔ∏è Innstillinger</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Zoomniv√•</span>
                            <span class="slider-value" id="zoomValue">12</span>
                        </div>
                        <input type="range" class="slider" id="zoomSlider" min="8" max="16" value="12" step="0.5">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Tekstst√∏rrelse</span>
                            <span class="slider-value" id="textSizeValue">100%</span>
                        </div>
                        <input type="range" class="slider" id="textSizeSlider" min="70" max="130" value="100" step="5">
                    </div>
                    <div class="slider-container" id="textPositionContainer">
                        <div class="slider-header">
                            <span class="slider-label">Horisontal posisjon</span>
                            <span class="slider-value" id="textXValue">50%</span>
                        </div>
                        <input type="range" class="slider" id="textXSlider" min="10" max="90" value="50" step="1">
                    </div>
                    <div class="slider-container" id="textYContainer">
                        <div class="slider-header">
                            <span class="slider-label">Vertikal posisjon</span>
                            <span class="slider-value" id="textYValue">85%</span>
                        </div>
                        <input type="range" class="slider" id="textYSlider" min="10" max="95" value="85" step="1">
                    </div>
                </div>

                <!-- Text Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">‚úèÔ∏è Tekst</span>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Tittel</label>
                        <input type="text" class="input" id="titleInput" value="Oslo" placeholder="Hovedtittel">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Undertittel</label>
                        <input type="text" class="input" id="subtitleInput" value="Norge" placeholder="Undertekst">
                    </div>
                </div>

                <!-- Font Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üî§ Skrifttype</span>
                    </div>
                    <div class="font-grid" id="fontGrid">
                        <!-- Fonts injected by JS -->
                    </div>
                </div>

                <!-- Text Theme Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üìù Tekst-tema</span>
                        <span class="section-badge">5 temaer</span>
                    </div>
                    <div class="frame-grid" id="themeGrid">
                        <button class="frame-btn active" data-theme="none" onclick="setTextTheme('none')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px; font-size: 8px;">Aa</div>
                            </div>
                            <span>Ingen</span>
                        </button>
                        <button class="frame-btn" data-theme="gradient" onclick="setTextTheme('gradient')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="background: linear-gradient(to bottom, transparent 30%, white 80%); display: flex; align-items: flex-end; justify-content: center; padding-bottom: 4px; font-size: 8px;">Aa</div>
                            </div>
                            <span>Gradient</span>
                        </button>
                        <button class="frame-btn" data-theme="box" onclick="setTextTheme('box')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="display: flex; align-items: flex-end; justify-content: center; padding-bottom: 8px;"><span style="background: white; border: 1px solid #333; padding: 2px 6px; font-size: 6px;">Aa</span></div>
                            </div>
                            <span>Boks</span>
                        </button>
                        <button class="frame-btn" data-theme="panel" onclick="setTextTheme('panel')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="position: relative;"><div style="position: absolute; bottom: 0; left: 0; right: 0; height: 35%; background: white; border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 6px;">Aa</div></div>
                            </div>
                            <span>Panel</span>
                        </button>
                        <button class="frame-btn" data-theme="double" onclick="setTextTheme('double')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="position: relative;"><div style="position: absolute; bottom: 0; left: 0; right: 0; height: 35%; background: white; border-top: 2px solid #333;"></div><div style="position: absolute; bottom: 0; left: 0; right: 0; height: 30%; border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 6px;">Aa</div></div>
                            </div>
                            <span>Dobbel</span>
                        </button>
                    </div>
                    <div class="slider-container" id="themeSizeContainer" style="margin-top: 12px; display: none;">
                        <div class="slider-header">
                            <span class="slider-label">Tema-h√∏yde</span>
                            <span class="slider-value" id="themeSizeValue">30%</span>
                        </div>
                        <input type="range" class="slider" id="themeSizeSlider" min="15" max="60" value="30" step="5">
                    </div>
                </div>

                <!-- Frame Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üñºÔ∏è Ramme</span>
                    </div>
                    <div class="frame-grid" id="frameGrid">
                        <button class="frame-btn active" data-frame="none" onclick="setFrame('none')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner"></div>
                            </div>
                            <span>Ingen</span>
                        </button>
                        <button class="frame-btn" data-frame="thin" onclick="setFrame('thin')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="border: 1px solid var(--text-secondary);"></div>
                            </div>
                            <span>Tynn</span>
                        </button>
                        <button class="frame-btn" data-frame="thick" onclick="setFrame('thick')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="border: 3px solid var(--text-secondary);"></div>
                            </div>
                            <span>Tykk</span>
                        </button>
                        <button class="frame-btn" data-frame="double" onclick="setFrame('double')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="border: 2px double var(--text-secondary);"></div>
                            </div>
                            <span>Dobbel</span>
                        </button>
                        <button class="frame-btn" data-frame="vintage" onclick="setFrame('vintage')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="border: 2px solid var(--text-secondary); box-shadow: inset 0 0 0 1px var(--text-secondary), inset 0 0 0 4px transparent, inset 0 0 0 5px var(--text-secondary);"></div>
                            </div>
                            <span>Vintage</span>
                        </button>
                        <button class="frame-btn" data-frame="ornate" onclick="setFrame('ornate')">
                            <div class="frame-preview">
                                <div class="frame-preview-inner" style="border: 1px solid var(--text-secondary); box-shadow: inset 0 0 0 2px transparent, inset 0 0 0 3px var(--text-secondary);"></div>
                            </div>
                            <span>Ornament</span>
                        </button>
                    </div>
                    <div class="input-group" style="margin-top: 16px;">
                        <label class="input-label">üé® Rammefarge</label>
                        <div class="color-input-wrapper">
                            <input type="color" class="color-picker" id="frameColorPicker" value="#2C2C2C">
                            <input type="text" class="color-hex" id="frameColorHex" value="#2C2C2C" maxlength="7">
                        </div>
                    </div>
                </div>

                <!-- Map Labels Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">ÔøΩ Kartjusteringer</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Fargemetning</span>
                            <span class="slider-value" id="mapSaturationValue">100%</span>
                        </div>
                        <input type="range" class="slider" id="mapSaturationSlider" min="0" max="200" value="100" step="10">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Kontrast</span>
                            <span class="slider-value" id="mapContrastValue">100%</span>
                        </div>
                        <input type="range" class="slider" id="mapContrastSlider" min="50" max="150" value="100" step="5">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Lysstyrke</span>
                            <span class="slider-value" id="mapBrightnessValue">100%</span>
                        </div>
                        <input type="range" class="slider" id="mapBrightnessSlider" min="50" max="150" value="100" step="5">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <span class="slider-label">Lys vignette</span>
                            <span class="slider-value" id="labelShadowValue">0px</span>
                        </div>
                        <input type="range" class="slider" id="labelShadowSlider" min="0" max="8" value="0" step="1">
                    </div>
                </div>

                <!-- Toggles Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üîò Visning</span>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-label">Vis stedsnavn</div>
                            <div class="toggle-desc">Byer, tettsteder, bydeler</div>
                        </div>
                        <div class="toggle-switch active" id="toggleLabels" onclick="toggleOption('labels')"></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-label">Vis koordinater</div>
                            <div class="toggle-desc">Lat/Long under tittel</div>
                        </div>
                        <div class="toggle-switch active" id="toggleCoords" onclick="toggleOption('coords')"></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-label">Vis skillelinjer</div>
                            <div class="toggle-desc">Dekorative linjer</div>
                        </div>
                        <div class="toggle-switch active" id="toggleLines" onclick="toggleOption('lines')"></div>
                    </div>
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <div class="toggle-label">Vis dato</div>
                            <div class="toggle-desc">Spesiell dato under koordinater</div>
                        </div>
                        <div class="toggle-switch" id="toggleDate" onclick="toggleOption('date')"></div>
                    </div>
                    <div id="dateInputWrapper" style="display: none; margin-top: 8px;">
                        <input type="date" class="input" id="dateInput" onchange="updateDate()" oninput="updateDate()">
                    </div>
                </div>

                <!-- Export Section -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-title">üíæ Eksporter</span>
                    </div>
                    <div class="export-section">
                        <!-- API Key Input -->
                        <div class="input-group" style="margin-bottom: 16px;">
                            <label class="input-label">Geoapify API-n√∏kkel (gratis)</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="password" id="apiKeyInput" class="text-input" 
                                    placeholder="Din API-n√∏kkel..." 
                                    style="flex: 1; font-size: 12px;"
                                    onchange="saveApiKey(this.value)">
                                <button class="toggle-btn" onclick="toggleApiKeyVisibility()" title="Vis/skjul">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                            </div>
                            <a href="https://myprojects.geoapify.com/" target="_blank" 
                                style="font-size: 11px; color: var(--accent); margin-top: 6px; display: inline-block;">
                                F√• gratis API-n√∏kkel (3000 kreditter/dag) ‚Üí
                            </a>
                        </div>
                        
                        <div class="export-quality">
                            <label class="input-label" style="margin-bottom: 10px; display: block;">Oppl√∏sning</label>
                            <div class="quality-grid">
                                <button class="quality-btn" data-scale="2" onclick="setExportScale(2)">
                                    <span class="quality-name">Standard</span>
                                    <span class="quality-size">~2400√ó3600</span>
                                </button>
                                <button class="quality-btn active" data-scale="4" onclick="setExportScale(4)">
                                    <span class="quality-name">H√∏y ‚ö°</span>
                                    <span class="quality-size">~4800√ó7200</span>
                                </button>
                                <button class="quality-btn" data-scale="6" onclick="setExportScale(6)">
                                    <span class="quality-name">Print ‚ö°</span>
                                    <span class="quality-size">~7200√ó10800</span>
                                </button>
                            </div>
                            <p style="font-size: 10px; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">‚ö° H√∏y og Print krever API-n√∏kkel for beste kvalitet. Standard fungerer uten.</p>
                        </div>
                        <button class="export-btn" onclick="exportPoster('png')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 15V3m0 12-4-4m4 4 4-4"></path>
                                <path d="M2 17v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2"></path>
                            </svg>
                            Last ned PNG (H√∏y kvalitet)
                        </button>
                        <button class="export-btn secondary" onclick="exportSimple()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 15V3m0 12-4-4m4 4 4-4"></path>
                                <path d="M2 17v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2"></path>
                            </svg>
                            Rask eksport (uten API)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <span class="footer-brand"><a href="https://www.laererliv.no/" target="_blank">L√¶rerliv</a> ¬© 2026</span>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-area">
            <!-- Info Button -->
            <button class="info-btn" onclick="openInfoModal()" title="Om Stedskart (I)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v-4M12 8h.01"></path>
                </svg>
            </button>

            <!-- Toolbar -->
            <div class="canvas-toolbar">
                <button class="toolbar-btn" onclick="zoomMap(-1)" title="Zoom ut (-)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35M8 11h6"></path>
                    </svg>
                </button>
                <button class="toolbar-btn" onclick="zoomMap(1)" title="Zoom inn (+)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"></path>
                    </svg>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="resetMap()" title="Tilbakestill kart (R)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                </button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="shareDesign()" title="Del design">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                </button>
            </div>

            <!-- Poster -->
            <div class="poster-container">
                <div class="poster-frame" id="posterFrame">
                    <!-- Corner decorations for ornate frame -->
                    <div class="corner-decor top-left"></div>
                    <div class="corner-decor top-right"></div>
                    <div class="corner-decor bottom-left"></div>
                    <div class="corner-decor bottom-right"></div>
                    
                    <div class="poster-inner" id="posterInner">
                        <div class="map-wrapper" id="mapWrapper">
                            <div id="map"></div>
                            <div class="map-glow-overlay" id="mapGlowOverlay"></div>
                        </div>
                        
                        <div class="poster-overlay">
                            <div class="poster-text" id="posterText">
                                <h1 class="poster-title" id="posterTitle">Oslo</h1>
                                <div class="poster-subtitle-wrapper" id="subtitleWrapper">
                                    <div class="poster-line" id="posterLine1"></div>
                                    <span class="poster-subtitle" id="posterSubtitle">Norge</span>
                                    <div class="poster-line" id="posterLine2"></div>
                                </div>
                                <p class="poster-coords" id="posterCoords">59.91¬∞ N, 10.75¬∞ E</p>
                                <p class="poster-date" id="posterDate" style="display: none;"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                        <div class="loading-text">Laster kart...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="infoModal" onclick="closeInfoModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4M12 8h.01"></path>
                    </svg>
                    Om Stedskart
                </h2>
                <button class="modal-close" onclick="closeInfoModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                            <polyline points="2 17 12 22 22 17"></polyline>
                            <polyline points="2 12 12 17 22 12"></polyline>
                        </svg>
                        Hva er Stedskart?
                    </h3>
                    <p>Stedskart lar deg lage vakre, personlige kartplakater av dine favorittplasser. Perfekt som gave, minne fra en spesiell reise, eller som unik veggdekorasjon.</p>
                    <p style="margin-top: 12px; font-size: 0.85rem; opacity: 0.7;">Kartdata ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" style="color: var(--accent);">OpenStreetMap</a> bidragsytere</p>
                </div>

                <div class="modal-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                        Slik bruker du Stedskart
                    </h3>
                    <ul>
                        <li>S√∏k etter et sted eller velg fra hurtigknappene</li>
                        <li>Dra i kartet for √• justere posisjonen</li>
                        <li>Bruk scroll eller knappene for √• zoome</li>
                        <li>Velg kartstil, farger og ramme etter smak</li>
                        <li>Tilpass tekst, tittelst√∏rrelse og plassering</li>
                        <li>Eksporter som h√∏yoppl√∏selig PNG (4x)</li>
                    </ul>
                </div>

                <div class="modal-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Hurtigtaster
                    </h3>
                    <ul>
                        <li><span class="keyboard-shortcut">+</span> / <span class="keyboard-shortcut">-</span> ‚Äî Zoom inn/ut</li>
                        <li><span class="keyboard-shortcut">R</span> ‚Äî Tilbakestill kart</li>
                        <li><span class="keyboard-shortcut">E</span> ‚Äî Eksporter plakat</li>
                        <li><span class="keyboard-shortcut">C</span> ‚Äî Kopier til utklippstavle</li>
                        <li><span class="keyboard-shortcut">I</span> ‚Äî √Öpne denne infoen</li>
                        <li><span class="keyboard-shortcut">Esc</span> ‚Äî Lukk dialog</li>
                    </ul>
                </div>

                <div class="modal-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Om skaperen
                    </h3>
                    <div class="about-creator">
                        <img src="logo.png" alt="L√¶rerliv logo" class="creator-logo" onerror="this.style.display='none'">
                        <div class="creator-info">
                            <h4>Kenneth Bareksten</h4>
                            <p>L√¶rer og hobbyprogrammerer som lager digitale verkt√∏y for √• gj√∏re hverdagen litt enklere og mer kreativ.</p>
                            <div class="creator-links">
                                <a href="https://www.laererliv.no/" target="_blank" class="creator-link">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                    </svg>
                                    www.laererliv.no
                                </a>
                                <a href="mailto:kenneth@laererliv.no" class="creator-link">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>
                                    kenneth@laererliv.no
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Configuration
        // ============================================
        
        // Geoapify API key - get your free key at https://myprojects.geoapify.com/
        let GEOAPIFY_API_KEY = localStorage.getItem('geoapify_api_key') || '';
        
        // Helper to get Geoapify tile URL
        function getGeoapifyTileUrl(style) {
            if (GEOAPIFY_API_KEY) {
                return `https://maps.geoapify.com/v1/tile/${style}/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`;
            }
            return null;
        }
        
        const MAP_STYLES = [
            {
                id: 'positron',
                name: 'Positron',
                desc: 'Lys og minimalistisk',
                colors: ['#F7F5F0', '#2C2C2C', '#E0E7ED', '#EDEEE8'],
                fallbackUrl: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#2C2C2C',
                bgColor: '#F7F5F0',
                geoapifyStyle: 'positron'
            },
            {
                id: 'dark-matter',
                name: 'Dark Matter',
                desc: 'M√∏rk og elegant',
                colors: ['#0A0A0F', '#F5F5F0', '#1A1A24', '#151520'],
                fallbackUrl: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#F5F5F0',
                bgColor: '#0A0A0F',
                geoapifyStyle: 'dark-matter'
            },
            {
                id: 'dark-matter-yellow',
                name: 'Gule Veier',
                desc: 'M√∏rk med gule veier',
                colors: ['#0A0A0F', '#C9A432', '#1A1A24', '#151520'],
                fallbackUrl: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#C9A432',
                bgColor: '#0A0A0F',
                geoapifyStyle: 'dark-matter-yellow-roads'
            },
            {
                id: 'dark-matter-brown',
                name: 'Brun Atmosf√¶re',
                desc: 'M√∏rk med varme toner',
                colors: ['#2A1B2D', '#F4D4B0', '#1A1020', '#201520'],
                fallbackUrl: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#F4D4B0',
                bgColor: '#2A1B2D',
                geoapifyStyle: 'dark-matter-brown'
            },
            {
                id: 'dark-matter-purple',
                name: 'Lilla Natt',
                desc: 'M√∏rk lilla stemning',
                colors: ['#1A1020', '#B090D0', '#251830', '#1F1228'],
                fallbackUrl: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#D0B0E0',
                bgColor: '#1A1020',
                geoapifyStyle: 'dark-matter-purple-roads'
            },
            {
                id: 'osm-bright',
                name: 'OSM Bright',
                desc: 'Lys og detaljert',
                colors: ['#F5F5F0', '#3A3A3A', '#5090C0', '#70A870'],
                fallbackUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#2C2C2C',
                bgColor: '#F5F5F0',
                geoapifyStyle: 'osm-bright'
            },
            {
                id: 'osm-carto',
                name: 'Klassisk OSM',
                desc: 'Standard kartutseende',
                colors: ['#F5F5F0', '#3A3A3A', '#AAD3DF', '#CDEBB0'],
                fallbackUrl: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                fallbackUrlNoLabels: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
                textColor: '#2C2C2C',
                bgColor: '#F5F5F0',
                geoapifyStyle: 'osm-carto'
            },
            {
                id: 'toner',
                name: 'Toner',
                desc: 'H√∏ykontrast svart/hvit',
                colors: ['#FFFFFF', '#000000', '#CCCCCC', '#EEEEEE'],
                fallbackUrl: 'https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://tiles.stadiamaps.com/tiles/stamen_toner_background/{z}/{x}/{y}{r}.png',
                textColor: '#000000',
                bgColor: '#FFFFFF',
                geoapifyStyle: 'toner'
            },
            {
                id: 'toner-grey',
                name: 'Toner Gr√•',
                desc: 'Myk svart/hvit',
                colors: ['#F0F0F0', '#505050', '#D0D0D0', '#E8E8E8'],
                fallbackUrl: 'https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://tiles.stadiamaps.com/tiles/stamen_toner_background/{z}/{x}/{y}{r}.png',
                textColor: '#3A3A3A',
                bgColor: '#F0F0F0',
                geoapifyStyle: 'toner-grey'
            },
            {
                id: 'watercolor',
                name: 'Akvarell',
                desc: 'Myk, malt estetikk',
                colors: ['#FAF8F5', '#787880', '#7BA3B8', '#A8B89C'],
                fallbackUrl: 'https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg',
                fallbackUrlNoLabels: 'https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg',
                textColor: '#4A4A4A',
                bgColor: '#FAF8F5',
                geoapifyStyle: 'osm-bright-smooth'
            },
            {
                id: 'terrain',
                name: 'Terreng',
                desc: 'Med h√∏ydekurver',
                colors: ['#F5E6D3', '#4A2E15', '#A8967C', '#E8F0E8'],
                fallbackUrl: 'https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png',
                fallbackUrlNoLabels: 'https://tiles.stadiamaps.com/tiles/stamen_terrain_background/{z}/{x}/{y}{r}.png',
                textColor: '#4A2E15',
                bgColor: '#F5E6D3',
                geoapifyStyle: 'klokantech-basic'
            }
        ];

        const FONTS = [
            { id: 'playfair', name: 'Playfair Display', family: "'Playfair Display', serif", style: 'Elegant serif' },
            { id: 'bebas', name: 'Bebas Neue', family: "'Bebas Neue', sans-serif", style: 'Kondensert' },
            { id: 'oswald', name: 'Oswald', family: "'Oswald', sans-serif", style: 'Moderne' },
            { id: 'cormorant', name: 'Cormorant', family: "'Cormorant Garamond', serif", style: 'Klassisk' },
            { id: 'montserrat', name: 'Montserrat', family: "'Montserrat', sans-serif", style: 'Geometrisk' },
            { id: 'baskerville', name: 'Libre Baskerville', family: "'Libre Baskerville', serif", style: 'Tradisjonell' },
            { id: 'raleway', name: 'Raleway', family: "'Raleway', sans-serif", style: 'Elegant sans' },
            { id: 'abril', name: 'Abril Fatface', family: "'Abril Fatface', serif", style: 'Display' }
        ];

        const NORWEGIAN_LOCATIONS = [
            { name: 'Oslo', region: 'Oslo', lat: 59.9139, lng: 10.7522 },
            { name: 'Bergen', region: 'Vestland', lat: 60.3913, lng: 5.3221 },
            { name: 'Trondheim', region: 'Tr√∏ndelag', lat: 63.4305, lng: 10.3951 },
            { name: 'Stavanger', region: 'Rogaland', lat: 58.9700, lng: 5.7331 },
            { name: 'Troms√∏', region: 'Troms og Finnmark', lat: 69.6496, lng: 18.9560 },
            { name: 'Kristiansand', region: 'Agder', lat: 58.1467, lng: 7.9956 },
            { name: 'Drammen', region: 'Viken', lat: 59.7439, lng: 10.2045 },
            { name: 'Fredrikstad', region: 'Viken', lat: 59.2181, lng: 10.9298 },
            { name: 'Sandnes', region: 'Rogaland', lat: 58.8524, lng: 5.7352 },
            { name: '√Ölesund', region: 'M√∏re og Romsdal', lat: 62.4722, lng: 6.1549 },
            { name: 'Bod√∏', region: 'Nordland', lat: 67.2804, lng: 14.4049 },
            { name: 'Sandefjord', region: 'Vestfold og Telemark', lat: 59.1318, lng: 10.2167 },
            { name: 'T√∏nsberg', region: 'Vestfold og Telemark', lat: 59.2676, lng: 10.4076 },
            { name: 'Moss', region: 'Viken', lat: 59.4350, lng: 10.6590 },
            { name: 'Haugesund', region: 'Rogaland', lat: 59.4138, lng: 5.2680 },
            { name: 'Lofoten', region: 'Nordland', lat: 68.2000, lng: 14.0000 },
            { name: 'Geiranger', region: 'M√∏re og Romsdal', lat: 62.1008, lng: 7.2060 },
            { name: 'Fl√•m', region: 'Vestland', lat: 60.8628, lng: 7.1130 },
            { name: 'Nordkapp', region: 'Troms og Finnmark', lat: 71.1690, lng: 25.7836 },
            { name: 'Lillehammer', region: 'Innlandet', lat: 61.1153, lng: 10.4662 },
            { name: 'Svalbard', region: 'Svalbard', lat: 78.2232, lng: 15.6267 },
            { name: 'Preikestolen', region: 'Rogaland', lat: 58.9863, lng: 6.1863 },
            { name: 'R√∏ros', region: 'Tr√∏ndelag', lat: 62.5745, lng: 11.3850 },
            { name: 'Sognefjord', region: 'Vestland', lat: 61.2000, lng: 6.8000 },
            { name: 'Hardangerfjord', region: 'Vestland', lat: 60.4000, lng: 6.5000 }
        ];

        // ============================================
        // State
        // ============================================
        
        let state = {
            location: { name: 'Oslo', lat: 59.9139, lng: 10.7522 },
            style: MAP_STYLES[0],
            font: FONTS[0],
            zoom: 12,
            margin: 5,
            bgColor: '#F7F5F0',
            textColor: '#2C2C2C',
            frameColor: '#2C2C2C',
            aspect: 'portrait',
            showCoords: true,
            showLines: true,
            showDate: false,
            dateValue: '',
            frameStyle: 'none',
            textTheme: 'none',
            themeSize: 30,
            showLabels: true,
            exportScale: 4,
            labelShadow: 2,
            mapSaturation: 100,
            mapContrast: 100,
            mapBrightness: 100,
            textSize: 100,
            textX: 50,
            textY: 85
        };

        let map = null;
        let tileLayer = null;

        // ============================================
        // Initialization
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderStyleGrid();
            renderFontGrid();
            setupEventListeners();
            initializeSliders();
            updatePoster();
            updateMapFilters();
            updateThemeColors();
            loadApiKey();
        });

        // Synkroniser alle slider-verdier fra state til DOM
        function initializeSliders() {
            // Zoom
            document.getElementById('zoomSlider').value = state.zoom;
            document.getElementById('zoomValue').textContent = state.zoom;
            
            // Tekstst√∏rrelse - oppdater slider, display og anvend p√• poster
            document.getElementById('textSizeSlider').value = state.textSize;
            document.getElementById('textSizeValue').textContent = state.textSize + '%';
            const scale = state.textSize / 100;
            document.getElementById('posterTitle').style.fontSize = (38 * scale) + 'px';
            document.getElementById('posterSubtitle').style.fontSize = (13 * scale) + 'px';
            document.getElementById('posterCoords').style.fontSize = (10 * scale) + 'px';
            
            // Tekstposisjon - oppdater slider, display og anvend p√• poster
            document.getElementById('textXSlider').value = state.textX;
            document.getElementById('textXValue').textContent = state.textX + '%';
            document.getElementById('textYSlider').value = state.textY;
            document.getElementById('textYValue').textContent = state.textY + '%';
            const posterText = document.querySelector('.poster-text');
            if (posterText) {
                posterText.style.left = state.textX + '%';
                posterText.style.top = state.textY + '%';
            }
            
            // Kartjusteringer
            document.getElementById('mapSaturationSlider').value = state.mapSaturation;
            document.getElementById('mapSaturationValue').textContent = state.mapSaturation + '%';
            document.getElementById('mapContrastSlider').value = state.mapContrast;
            document.getElementById('mapContrastValue').textContent = state.mapContrast + '%';
            document.getElementById('mapBrightnessSlider').value = state.mapBrightness;
            document.getElementById('mapBrightnessValue').textContent = state.mapBrightness + '%';
            
            // Hvit gl√∏d / Lys vignette
            document.getElementById('labelShadowSlider').value = state.labelShadow;
            document.getElementById('labelShadowValue').textContent = state.labelShadow + 'px';
            // Anvend gl√∏d-effekten ved oppstart
            const glowOverlay = document.getElementById('mapGlowOverlay');
            if (glowOverlay) {
                glowOverlay.style.opacity = state.labelShadow / 10;
            }
            
            // Tema-h√∏yde
            document.getElementById('themeSizeSlider').value = state.themeSize;
            document.getElementById('themeSizeValue').textContent = state.themeSize + '%';
            
            // Rammefarge
            document.getElementById('frameColorPicker').value = state.frameColor;
            document.getElementById('frameColorHex').value = state.frameColor.toUpperCase();
        }

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                dragging: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                touchZoom: true
            }).setView([state.location.lat, state.location.lng], state.zoom);

            // Get initial tile URL
            let tileUrl;
            if (GEOAPIFY_API_KEY && state.style.geoapifyStyle) {
                tileUrl = `https://maps.geoapify.com/v1/tile/${state.style.geoapifyStyle}/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`;
            } else {
                tileUrl = state.style.fallbackUrl || state.style.url;
            }
            
            tileLayer = L.tileLayer(tileUrl, {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            map.on('moveend', updateCoords);
            map.on('zoomend', () => {
                state.zoom = map.getZoom();
                document.getElementById('zoomSlider').value = state.zoom;
                document.getElementById('zoomValue').textContent = state.zoom;
            });

            // Initialize label styling after map loads
            setTimeout(() => {
                updateLabelShadow(state.labelShadow);
            }, 500);
        }

        // ============================================
        // Render Functions
        // ============================================
        
        function renderStyleGrid() {
            const grid = document.getElementById('styleGrid');
            grid.innerHTML = MAP_STYLES.map(style => `
                <div class="style-card ${state.style.id === style.id ? 'active' : ''}" 
                     onclick="selectStyle('${style.id}')">
                    <div class="style-preview">
                        ${style.colors.map(c => `<div class="style-color" style="background: ${c}"></div>`).join('')}
                    </div>
                    <div class="style-name">${style.name}</div>
                    <div class="style-desc">${style.desc}</div>
                    <div class="style-check">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#0a0a0f" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </div>
            `).join('');
        }

        function renderFontGrid() {
            const grid = document.getElementById('fontGrid');
            grid.innerHTML = FONTS.map(font => `
                <button class="font-btn ${state.font.id === font.id ? 'active' : ''}" 
                        data-font="${font.id}"
                        onclick="selectFont('${font.id}')">
                    <span class="font-preview" style="font-family: ${font.family}">Aa</span>
                    <span class="font-name">${font.name}</span>
                </button>
            `).join('');
        }

        function selectFont(fontId) {
            state.font = FONTS.find(f => f.id === fontId);
            const fontFamily = state.font.family;
            document.getElementById('posterTitle').style.fontFamily = fontFamily;
            document.getElementById('posterSubtitle').style.fontFamily = fontFamily;
            document.getElementById('posterCoords').style.fontFamily = fontFamily;
            const dateEl = document.getElementById('posterDate');
            if (dateEl) dateEl.style.fontFamily = fontFamily;
            renderFontGrid();
        }

        // ============================================
        // Style & Color Functions
        // ============================================
        
        function selectStyle(styleId) {
            state.style = MAP_STYLES.find(s => s.id === styleId);
            state.bgColor = state.style.bgColor;
            state.textColor = state.style.textColor;
            
            // Update map tiles respecting labels setting
            updateMapTiles();
            
            // Apply vintage effect if vintage style
            const mapWrapper = document.getElementById('mapWrapper');
            if (styleId === 'vintage') {
                mapWrapper.classList.add('vintage-map');
            } else {
                mapWrapper.classList.remove('vintage-map');
            }
            
            // Update theme colors to match new style
            updateThemeColors();
            
            updatePoster();
            renderStyleGrid();
        }

        function getBrightness(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        // ============================================
        // Location Functions
        // ============================================
        
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }

                const matches = NORWEGIAN_LOCATIONS.filter(loc => 
                    loc.name.toLowerCase().includes(query) || 
                    loc.region.toLowerCase().includes(query)
                ).slice(0, 6);

                if (matches.length > 0) {
                    searchResults.innerHTML = matches.map(loc => `
                        <div class="search-result-item" onclick="selectLocation(${loc.lat}, ${loc.lng}, '${loc.name}')">
                            <div class="search-result-name">${loc.name}</div>
                            <div class="search-result-region">${loc.region}</div>
                        </div>
                    `).join('');
                    searchResults.classList.add('active');
                } else {
                    searchResults.classList.remove('active');
                }
            });

            searchInput.addEventListener('blur', () => {
                setTimeout(() => searchResults.classList.remove('active'), 200);
            });

            // Sliders
            document.getElementById('zoomSlider').addEventListener('input', (e) => {
                state.zoom = parseFloat(e.target.value);
                document.getElementById('zoomValue').textContent = state.zoom;
                map.setZoom(state.zoom);
            });

            document.getElementById('textSizeSlider').addEventListener('input', (e) => {
                const size = parseInt(e.target.value);
                state.textSize = size;
                document.getElementById('textSizeValue').textContent = size + '%';
                const scale = size / 100;
                document.getElementById('posterTitle').style.fontSize = (38 * scale) + 'px';
                document.getElementById('posterSubtitle').style.fontSize = (13 * scale) + 'px';
                document.getElementById('posterCoords').style.fontSize = (10 * scale) + 'px';
            });

            // Text inputs
            document.getElementById('titleInput').addEventListener('input', (e) => {
                document.getElementById('posterTitle').textContent = e.target.value || 'Tittel';
            });

            document.getElementById('subtitleInput').addEventListener('input', (e) => {
                document.getElementById('posterSubtitle').textContent = e.target.value || '';
            });

            // Frame color picker
            document.getElementById('frameColorPicker').addEventListener('input', (e) => {
                updateFrameColor(e.target.value);
            });

            document.getElementById('frameColorHex').addEventListener('input', (e) => {
                let value = e.target.value;
                if (!value.startsWith('#')) value = '#' + value;
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    updateFrameColor(value);
                }
            });

            // White glow control
            document.getElementById('labelShadowSlider').addEventListener('input', (e) => {
                updateLabelShadow(parseInt(e.target.value));
            });

            // Map adjustment controls
            document.getElementById('mapSaturationSlider').addEventListener('input', (e) => {
                state.mapSaturation = parseInt(e.target.value);
                updateMapFilters();
            });

            document.getElementById('mapContrastSlider').addEventListener('input', (e) => {
                state.mapContrast = parseInt(e.target.value);
                updateMapFilters();
            });

            document.getElementById('mapBrightnessSlider').addEventListener('input', (e) => {
                state.mapBrightness = parseInt(e.target.value);
                updateMapFilters();
            });

            // Theme size slider
            document.getElementById('themeSizeSlider').addEventListener('input', (e) => {
                updateThemeSize(parseInt(e.target.value));
            });

            // Text position sliders
            document.getElementById('textXSlider').addEventListener('input', (e) => {
                updateTextX(e.target.value);
            });

            document.getElementById('textYSlider').addEventListener('input', (e) => {
                updateTextY(e.target.value);
            });
        }

        function selectLocation(lat, lng, name) {
            state.location = { lat, lng, name };
            map.setView([lat, lng], state.zoom);
            
            document.getElementById('searchInput').value = name;
            document.getElementById('titleInput').value = name;
            document.getElementById('posterTitle').textContent = name;
            document.getElementById('searchResults').classList.remove('active');
            
            updateCoords();
        }

        function randomLocation() {
            const loc = NORWEGIAN_LOCATIONS[Math.floor(Math.random() * NORWEGIAN_LOCATIONS.length)];
            selectLocation(loc.lat, loc.lng, loc.name);
        }

        function updateCoords() {
            const center = map.getCenter();
            const latDir = center.lat >= 0 ? 'N' : 'S';
            const lngDir = center.lng >= 0 ? 'E' : 'W';
            const coords = `${Math.abs(center.lat).toFixed(2)}¬∞ ${latDir}, ${Math.abs(center.lng).toFixed(2)}¬∞ ${lngDir}`;
            document.getElementById('posterCoords').textContent = coords;
        }

        // ============================================
        // Poster Functions
        // ============================================
        
        function updatePoster() {
            const frame = document.getElementById('posterFrame');
            const inner = document.getElementById('posterInner');
            const posterText = document.querySelector('.poster-text');
            const title = document.getElementById('posterTitle');
            const subtitle = document.getElementById('posterSubtitle');
            const coords = document.getElementById('posterCoords');
            const dateEl = document.getElementById('posterDate');
            const line1 = document.getElementById('posterLine1');
            const line2 = document.getElementById('posterLine2');

            // Background
            frame.style.background = state.bgColor;

            // Text position (only if not using panel themes)
            posterText.style.left = `${state.textX}%`;
            if (state.textTheme !== 'panel' && state.textTheme !== 'double' && state.textTheme !== 'gradient') {
                posterText.style.top = `${state.textY}%`;
            }

            // Text colors - only apply if no text theme is active (themes set their own colors)
            if (state.textTheme === 'none') {
                title.style.color = state.textColor;
                subtitle.style.color = state.textColor;
                coords.style.color = state.textColor;
                dateEl.style.color = state.textColor;
                line1.style.backgroundColor = state.textColor;
                line2.style.backgroundColor = state.textColor;
            }

            // Frame color via CSS variable
            frame.style.setProperty('--frame-color', state.textColor);

            // Corner decorations color
            document.querySelectorAll('.corner-decor').forEach(el => {
                el.style.borderColor = state.textColor;
            });

            updateMapWrapper();
        }
        
        function isColorLight(color) {
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }

        function updateMapWrapper() {
            setTimeout(() => map.invalidateSize(), 100);
        }

        function setAspect(aspect) {
            state.aspect = aspect;
            const frame = document.getElementById('posterFrame');
            
            frame.classList.remove('portrait', 'landscape', 'square');
            if (aspect !== 'portrait') frame.classList.add(aspect);

            document.querySelectorAll('.perspective-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.aspect === aspect);
            });

            updateMapWrapper();
            setTimeout(() => map.invalidateSize(), 300);
        }

        function toggleOption(option) {
            const toggle = document.getElementById(`toggle${option.charAt(0).toUpperCase() + option.slice(1)}`);
            
            if (option === 'coords') {
                state.showCoords = !state.showCoords;
                document.getElementById('posterCoords').style.display = state.showCoords ? 'block' : 'none';
            } else if (option === 'lines') {
                state.showLines = !state.showLines;
                document.getElementById('subtitleWrapper').style.display = state.showLines ? 'flex' : 'none';
            } else if (option === 'labels') {
                state.showLabels = !state.showLabels;
                updateMapTiles();
            } else if (option === 'date') {
                state.showDate = !state.showDate;
                document.getElementById('posterDate').style.display = state.showDate ? 'block' : 'none';
                document.getElementById('dateInputWrapper').style.display = state.showDate ? 'block' : 'none';
            }
            
            toggle.classList.toggle('active');
        }

        function updateDate() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput.value) {
                const date = new Date(dateInput.value);
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const formattedDate = date.toLocaleDateString('nb-NO', options);
                state.dateValue = formattedDate;
                document.getElementById('posterDate').textContent = formattedDate;
            }
        }

        function updateTextX(value) {
            state.textX = parseInt(value);
            document.getElementById('textXValue').textContent = `${value}%`;
            const posterText = document.querySelector('.poster-text');
            posterText.style.left = `${value}%`;
        }

        function updateTextY(value) {
            state.textY = parseInt(value);
            document.getElementById('textYValue').textContent = `${value}%`;
            const posterText = document.querySelector('.poster-text');
            // Only update Y position if not using fixed-position themes
            if (state.textTheme !== 'panel' && state.textTheme !== 'double' && state.textTheme !== 'gradient') {
                posterText.style.top = `${value}%`;
            }
        }

        function setFrame(frameStyle) {
            state.frameStyle = frameStyle;
            const frame = document.getElementById('posterFrame');
            
            // Remove all frame classes
            frame.classList.remove('frame-none', 'frame-thin', 'frame-thick', 'frame-double', 'frame-vintage', 'frame-ornate');
            
            // Add new frame class
            if (frameStyle !== 'none') {
                frame.classList.add(`frame-${frameStyle}`);
            }
            
            // Update button states
            document.querySelectorAll('.frame-btn[data-frame]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.frame === frameStyle);
            });
            
            // Update frame colors via CSS variables
            frame.style.setProperty('--frame-color', state.frameColor);
            frame.style.setProperty('--frame-bg', state.bgColor);
            
            setTimeout(() => map.invalidateSize(), 100);
        }

        function setTextTheme(theme) {
            state.textTheme = theme;
            const overlay = document.querySelector('.poster-overlay');
            
            // Remove all theme classes
            overlay.classList.remove('theme-none', 'theme-gradient', 'theme-box', 'theme-panel', 'theme-double');
            
            // Add new theme class
            if (theme !== 'none') {
                overlay.classList.add(`theme-${theme}`);
            }
            
            // Update theme colors to match current map style
            updateThemeColors();
            
            // Update button states
            document.querySelectorAll('.frame-btn[data-theme]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            
            // Show/hide size slider (not applicable for none or box)
            const sizeContainer = document.getElementById('themeSizeContainer');
            const posYContainer = document.getElementById('textYContainer');
            
            if (theme === 'gradient' || theme === 'panel' || theme === 'double') {
                sizeContainer.style.display = 'block';
                if (posYContainer) posYContainer.style.display = 'none'; // Hide Y position when theme controls it
            } else {
                sizeContainer.style.display = 'none';
                if (posYContainer) posYContainer.style.display = 'block';
            }
            
            // Adjust text position for themes that need it
            const posterText = document.querySelector('.poster-text');
            if (theme === 'panel' || theme === 'double') {
                // Center text vertically in the panel area
                posterText.style.top = '88%';
            } else if (theme === 'gradient') {
                posterText.style.top = '85%';
            } else {
                posterText.style.top = `${state.textY}%`;
            }
        }
        
        function updateThemeColors() {
            const overlay = document.querySelector('.poster-overlay');
            if (!overlay) return;
            
            // Use map style's bgColor for theme background and textColor for text/borders
            const themeColor = state.style.bgColor || '#ffffff';
            const themeBorderColor = state.style.textColor || '#2C2C2C';
            const themeTextColor = state.style.textColor || '#2C2C2C';
            
            overlay.style.setProperty('--theme-color', themeColor);
            overlay.style.setProperty('--theme-border-color', themeBorderColor);
            overlay.style.setProperty('--theme-text-color', themeTextColor);
            overlay.style.setProperty('--theme-size', `${state.themeSize}%`);
            
            // Apply text colors directly when theme is active (to override inline styles)
            if (state.textTheme !== 'none') {
                const title = document.getElementById('posterTitle');
                const subtitle = document.getElementById('posterSubtitle');
                const coords = document.getElementById('posterCoords');
                const dateEl = document.getElementById('posterDate');
                const line1 = document.getElementById('posterLine1');
                const line2 = document.getElementById('posterLine2');
                
                title.style.color = themeTextColor;
                subtitle.style.color = themeTextColor;
                coords.style.color = themeTextColor;
                dateEl.style.color = themeTextColor;
                line1.style.backgroundColor = themeTextColor;
                line2.style.backgroundColor = themeTextColor;
            }
        }
        
        function updateThemeSize(size) {
            state.themeSize = size;
            const overlay = document.querySelector('.poster-overlay');
            overlay.style.setProperty('--theme-size', `${size}%`);
            document.getElementById('themeSizeValue').textContent = `${size}%`;
            
            // Force repaint to apply CSS variable to pseudo-elements
            overlay.classList.remove(`theme-${state.textTheme}`);
            void overlay.offsetWidth; // Force reflow
            if (state.textTheme !== 'none') {
                overlay.classList.add(`theme-${state.textTheme}`);
            }
        }

        function updateFrameColor(color) {
            state.frameColor = color;
            const frame = document.getElementById('posterFrame');
            frame.style.setProperty('--frame-color', color);
            
            // Update both picker and hex input
            document.getElementById('frameColorPicker').value = color;
            document.getElementById('frameColorHex').value = color.toUpperCase();
        }

        function updateLabelShadow(size) {
            state.labelShadow = size;
            document.getElementById('labelShadowValue').textContent = `${size}px`;
            
            // Oppdater hvit gl√∏d-overlay
            const glowOverlay = document.getElementById('mapGlowOverlay');
            if (glowOverlay) {
                // Konverter 0-8 til opacity 0-0.8
                const opacity = size / 10;
                glowOverlay.style.opacity = opacity;
            }
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function updateMapFilters() {
            const mapEl = document.getElementById('map');
            
            // Bruk state-verdier (oppdateres fra event listeners)
            const saturation = state.mapSaturation;
            const contrast = state.mapContrast;
            const brightness = state.mapBrightness;
            
            // Build filter string
            let filters = [];
            
            // Add label shadow if active
            if (state.labelShadow > 0) {
                for (let i = 0; i < 3; i++) {
                    filters.push(`drop-shadow(0 0 ${state.labelShadow}px white)`);
                }
            }
            
            // Add color adjustments
            filters.push(`saturate(${saturation}%)`);
            filters.push(`contrast(${contrast}%)`);
            filters.push(`brightness(${brightness}%)`);
            
            const filterString = filters.join(' ');
            mapEl.style.setProperty('filter', filterString, 'important');
            
            // Update display values
            document.getElementById('mapSaturationValue').textContent = `${saturation}%`;
            document.getElementById('mapContrastValue').textContent = `${contrast}%`;
            document.getElementById('mapBrightnessValue').textContent = `${brightness}%`;
        }

        function updateMapTiles() {
            let tileUrl;
            
            // Use Geoapify tiles when API key is available
            if (GEOAPIFY_API_KEY && state.style.geoapifyStyle) {
                tileUrl = `https://maps.geoapify.com/v1/tile/${state.style.geoapifyStyle}/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_API_KEY}`;
            } else {
                // Fallback to free tiles
                tileUrl = state.showLabels 
                    ? (state.style.fallbackUrl || state.style.url) 
                    : (state.style.fallbackUrlNoLabels || state.style.urlNoLabels || state.style.fallbackUrl || state.style.url);
            }
            
            map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(tileUrl, {
                maxZoom: 19,
                attribution: GEOAPIFY_API_KEY ? '¬© Geoapify ¬© OpenStreetMap' : '¬© OpenStreetMap'
            }).addTo(map);
        }

        // ============================================
        // Map Controls
        // ============================================
        
        function zoomMap(delta) {
            state.zoom = Math.max(8, Math.min(16, state.zoom + delta * 0.5));
            map.setZoom(state.zoom);
            document.getElementById('zoomSlider').value = state.zoom;
            document.getElementById('zoomValue').textContent = state.zoom;
        }

        function resetMap() {
            map.setView([state.location.lat, state.location.lng], 12);
            state.zoom = 12;
            document.getElementById('zoomSlider').value = 12;
            document.getElementById('zoomValue').textContent = 12;
        }

        function setExportScale(scale) {
            state.exportScale = scale;
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.scale) === scale);
            });
        }

        // ============================================
        // Export Functions
        // ============================================
        
        function saveApiKey(key) {
            GEOAPIFY_API_KEY = key;
            localStorage.setItem('geoapify_api_key', key);
        }
        
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        function loadApiKey() {
            const savedKey = localStorage.getItem('geoapify_api_key');
            if (savedKey) {
                GEOAPIFY_API_KEY = savedKey;
                const input = document.getElementById('apiKeyInput');
                if (input) input.value = savedKey;
            }
        }
        
        async function exportPoster(format) {
            // Check if API key is available
            if (!GEOAPIFY_API_KEY) {
                showNotification('Vennligst legg inn Geoapify API-n√∏kkel for h√∏ykvalitetseksport', 'error');
                document.getElementById('apiKeyInput').focus();
                return;
            }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            
            const scaleNames = { 2: 'Standard', 4: 'H√∏y (4K)', 6: 'Print (6K)' };
            loading.querySelector('.loading-text').textContent = `Forbereder ${scaleNames[state.exportScale]} eksport...`;

            try {
                // Get poster dimensions
                const poster = document.getElementById('posterFrame');
                const posterRect = poster.getBoundingClientRect();
                const scale = state.exportScale;
                
                // Final poster size
                const posterWidth = Math.round(posterRect.width * scale);
                const posterHeight = Math.round(posterRect.height * scale);
                
                // Calculate map area dimensions (accounting for margin)
                const marginPercent = state.margin / 100;
                const mapAreaWidth = Math.round(posterWidth * (1 - marginPercent * 2));
                const mapAreaHeight = Math.round(posterHeight * (1 - marginPercent * 2));
                
                // Get map center and zoom for exact positioning
                const center = map.getCenter();
                const zoom = map.getZoom();
                
                loading.querySelector('.loading-text').textContent = 'Henter h√∏yoppl√∏selig kart fra Geoapify...';
                
                // Geoapify max is 4096x4096, with scaleFactor=2 we get 8192x8192
                // We may need to tile for very large exports
                const maxGeoapifySize = 4096;
                const scaleFactor = 2; // Double resolution
                
                // Calculate how to best fit within Geoapify limits
                let requestWidth, requestHeight;
                const aspectRatio = mapAreaWidth / mapAreaHeight;
                
                if (mapAreaWidth > mapAreaHeight) {
                    requestWidth = Math.min(maxGeoapifySize, Math.round(mapAreaWidth / scaleFactor));
                    requestHeight = Math.round(requestWidth / aspectRatio);
                    if (requestHeight > maxGeoapifySize) {
                        requestHeight = maxGeoapifySize;
                        requestWidth = Math.round(requestHeight * aspectRatio);
                    }
                } else {
                    requestHeight = Math.min(maxGeoapifySize, Math.round(mapAreaHeight / scaleFactor));
                    requestWidth = Math.round(requestHeight * aspectRatio);
                    if (requestWidth > maxGeoapifySize) {
                        requestWidth = maxGeoapifySize;
                        requestHeight = Math.round(requestWidth / aspectRatio);
                    }
                }
                
                // Get Geoapify style from current map style
                // All Geoapify tile styles are also supported by Static Maps API
                const geoapifyStyle = state.style.geoapifyStyle || 'osm-bright';
                
                // Build Geoapify Static Map URL using CENTER and ZOOM for exact match
                const geoapifyUrl = `https://maps.geoapify.com/v1/staticmap?` +
                    `style=${geoapifyStyle}` +
                    `&width=${requestWidth}` +
                    `&height=${requestHeight}` +
                    `&center=lonlat:${center.lng},${center.lat}` +
                    `&zoom=${zoom}` +
                    `&scaleFactor=${scaleFactor}` +
                    `&format=png` +
                    `&apiKey=${GEOAPIFY_API_KEY}`;
                
                console.log('Fetching map from:', geoapifyUrl);
                
                // Fetch the map image
                const response = await fetch(geoapifyUrl);
                if (!response.ok) {
                    throw new Error(`Geoapify API feil: ${response.status} ${response.statusText}`);
                }
                
                const mapBlob = await response.blob();
                const mapImg = await createImageBitmap(mapBlob);
                
                loading.querySelector('.loading-text').textContent = 'Bygger poster med h√∏yoppl√∏selig kart...';
                
                // Create final canvas
                const canvas = document.createElement('canvas');
                canvas.width = posterWidth;
                canvas.height = posterHeight;
                const ctx = canvas.getContext('2d');
                
                // Draw background
                ctx.fillStyle = state.bgColor;
                ctx.fillRect(0, 0, posterWidth, posterHeight);
                
                // Calculate map position (centered with margin)
                const mapX = Math.round(posterWidth * marginPercent);
                const mapY = Math.round(posterHeight * marginPercent);
                
                // Draw the map image - stretch to fill exactly (matches Leaflet behavior)
                ctx.drawImage(mapImg, mapX, mapY, mapAreaWidth, mapAreaHeight);
                
                // Cover Geoapify attribution at bottom of map with background color
                const attributionHeight = 20 * scale;
                ctx.fillStyle = state.bgColor;
                ctx.fillRect(mapX, mapY + mapAreaHeight - attributionHeight, mapAreaWidth, attributionHeight);
                
                // Draw vignette effect if enabled (lys vignette)
                if (state.labelShadow > 0) {
                    const vignetteOpacity = state.labelShadow / 10;
                    const vignetteGradient = ctx.createRadialGradient(
                        mapX + mapAreaWidth / 2, mapY + mapAreaHeight / 2, 0,
                        mapX + mapAreaWidth / 2, mapY + mapAreaHeight / 2, Math.max(mapAreaWidth, mapAreaHeight) * 0.7
                    );
                    vignetteGradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
                    vignetteGradient.addColorStop(0.4, 'rgba(255, 255, 255, 0)');
                    vignetteGradient.addColorStop(0.7, `rgba(255, 255, 255, ${vignetteOpacity * 0.3})`);
                    vignetteGradient.addColorStop(0.9, `rgba(255, 255, 255, ${vignetteOpacity * 0.6})`);
                    vignetteGradient.addColorStop(1, `rgba(255, 255, 255, ${vignetteOpacity * 0.8})`);
                    ctx.fillStyle = vignetteGradient;
                    ctx.fillRect(mapX, mapY, mapAreaWidth, mapAreaHeight);
                }
                
                // Draw text overlay
                loading.querySelector('.loading-text').textContent = 'Legger til tekst...';
                
                // Text styling - use textSize percentage from state
                const textScale = state.textSize / 100;
                const titleSize = 38 * scale * textScale;
                const subtitleSize = 13 * scale * textScale;
                const coordsSize = 10 * scale * textScale;
                const dateSize = 12 * scale * textScale;
                const padding = 28 * scale;
                const lineWidth = 36 * scale * textScale;
                const lineHeight = 1.5 * scale;
                
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Calculate text position using free positioning
                let textX = mapX + (mapAreaWidth * state.textX / 100);
                let textY = mapY + (mapAreaHeight * state.textY / 100);
                
                // Calculate total text height to ensure it fits within map area
                const totalTextHeight = titleSize + subtitleSize * 1.2 + coordsSize * 1.5 + dateSize * 1.5;
                const maxTextY = mapY + mapAreaHeight - totalTextHeight - 10 * scale;
                
                // Adjust for theme - position text in center of theme area
                if (state.textTheme === 'panel' || state.textTheme === 'double') {
                    // Theme starts at (1 - themeSize/100) from top
                    const themeTopY = mapY + mapAreaHeight * (1 - state.themeSize / 100);
                    const themeHeight = mapAreaHeight * (state.themeSize / 100);
                    // Center title vertically in the theme area (adjusted for subtitle below)
                    textY = themeTopY + themeHeight * 0.35;
                } else if (state.textTheme === 'gradient') {
                    const themeTopY = mapY + mapAreaHeight * (1 - state.themeSize / 100);
                    const themeHeight = mapAreaHeight * (state.themeSize / 100);
                    // Position text in lower part of gradient
                    textY = themeTopY + themeHeight * 0.5;
                }
                
                // Ensure text doesn't go below the map area
                textY = Math.min(textY, maxTextY);
                
                // Draw text theme backgrounds
                // Get theme colors from map style
                const themeColor = state.style.bgColor || '#ffffff';
                const themeBorderColor = state.style.textColor || '#2C2C2C';
                
                // Convert hex to rgba for gradient
                const hexToRgba = (hex, alpha) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r},${g},${b},${alpha})`;
                };
                
                if (state.textTheme === 'gradient') {
                    // Use themeSize from state
                    const gradientStartY = mapY + mapAreaHeight * (1 - state.themeSize / 100);
                    const gradientEndY = mapY + mapAreaHeight;
                    const gradient = ctx.createLinearGradient(0, gradientStartY, 0, gradientEndY);
                    gradient.addColorStop(0, hexToRgba(themeColor, 0));
                    gradient.addColorStop(1, hexToRgba(themeColor, 1));
                    ctx.fillStyle = gradient;
                    ctx.fillRect(mapX, gradientStartY, mapAreaWidth, gradientEndY - gradientStartY);
                } else if (state.textTheme === 'panel') {
                    ctx.fillStyle = themeColor;
                    ctx.fillRect(mapX, mapY + mapAreaHeight * (1 - state.themeSize / 100), mapAreaWidth, mapAreaHeight * (state.themeSize / 100));
                    ctx.strokeStyle = themeBorderColor;
                    ctx.lineWidth = 2 * scale;
                    ctx.beginPath();
                    ctx.moveTo(mapX, mapY + mapAreaHeight * (1 - state.themeSize / 100));
                    ctx.lineTo(mapX + mapAreaWidth, mapY + mapAreaHeight * (1 - state.themeSize / 100));
                    ctx.stroke();
                } else if (state.textTheme === 'double') {
                    ctx.fillStyle = themeColor;
                    ctx.fillRect(mapX, mapY + mapAreaHeight * (1 - state.themeSize / 100), mapAreaWidth, mapAreaHeight * (state.themeSize / 100));
                    ctx.strokeStyle = themeBorderColor;
                    ctx.lineWidth = 3 * scale;
                    ctx.beginPath();
                    ctx.moveTo(mapX, mapY + mapAreaHeight * (1 - state.themeSize / 100));
                    ctx.lineTo(mapX + mapAreaWidth, mapY + mapAreaHeight * (1 - state.themeSize / 100));
                    ctx.stroke();
                    ctx.lineWidth = 1 * scale;
                    ctx.beginPath();
                    ctx.moveTo(mapX, mapY + mapAreaHeight * (1 - state.themeSize / 100 + 0.03));
                    ctx.lineTo(mapX + mapAreaWidth, mapY + mapAreaHeight * (1 - state.themeSize / 100 + 0.03));
                    ctx.stroke();
                } else if (state.textTheme === 'box') {
                    // Draw box behind text - scale with text size
                    const boxPaddingX = 48 * scale * textScale;
                    const boxPaddingY = 32 * scale * textScale;
                    
                    // Measure the title to get proper box size
                    ctx.font = `700 ${titleSize}px ${state.font.family.replace(/'/g, '')}`;
                    const titleText = document.getElementById('titleInput').value || state.location.name;
                    const titleWidth = ctx.measureText(titleText.toUpperCase()).width;
                    
                    const boxWidth = Math.max(titleWidth + boxPaddingX * 2, 150 * scale * textScale);
                    const boxHeight = titleSize * 2.5 + boxPaddingY;
                    
                    ctx.fillStyle = themeColor;
                    ctx.fillRect(textX - boxWidth/2, textY - boxHeight/2, boxWidth, boxHeight);
                    ctx.strokeStyle = themeBorderColor;
                    ctx.lineWidth = 2 * scale;
                    ctx.strokeRect(textX - boxWidth/2, textY - boxHeight/2, boxWidth, boxHeight);
                }
                
                // Set text color based on theme
                const textColorForTheme = (state.textTheme !== 'none') ? themeBorderColor : state.textColor;
                
                // Text shadow (only for no theme)
                if (state.textTheme === 'none') {
                    const shadowBlur = state.labelShadow * scale;
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = shadowBlur;
                    ctx.shadowOffsetY = shadowBlur / 2;
                } else {
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                }
                
                // Draw title
                ctx.fillStyle = textColorForTheme;
                ctx.font = `700 ${titleSize}px ${state.font.family.replace(/'/g, '')}`;
                ctx.letterSpacing = `${titleSize * 0.08}px`;
                
                // Get title from input field
                const titleText = document.getElementById('titleInput').value || state.location.name;
                ctx.fillText(titleText.toUpperCase(), textX, textY);
                
                // Draw subtitle with lines
                const subtitleY = textY + titleSize * 0.8;
                ctx.font = `500 ${subtitleSize}px 'DM Sans', sans-serif`;
                ctx.letterSpacing = `${subtitleSize * 0.2}px`;
                
                // Get subtitle from input field
                const subtitleText = document.getElementById('subtitleInput').value || 'Norge';
                
                if (state.showLines && subtitleText) {
                    // Measure subtitle
                    const subtitleWidth = ctx.measureText(subtitleText.toUpperCase()).width;
                    
                    // Draw lines
                    ctx.beginPath();
                    ctx.strokeStyle = textColorForTheme;
                    ctx.lineWidth = lineHeight;
                    ctx.globalAlpha = 0.5;
                    
                    // Left line
                    ctx.moveTo(textX - subtitleWidth / 2 - 14 * scale - lineWidth, subtitleY);
                    ctx.lineTo(textX - subtitleWidth / 2 - 14 * scale, subtitleY);
                    
                    // Right line
                    ctx.moveTo(textX + subtitleWidth / 2 + 14 * scale, subtitleY);
                    ctx.lineTo(textX + subtitleWidth / 2 + 14 * scale + lineWidth, subtitleY);
                    
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }
                
                ctx.fillStyle = textColorForTheme;
                ctx.globalAlpha = 0.9;
                if (subtitleText) {
                    ctx.fillText(subtitleText.toUpperCase(), textX, subtitleY);
                }
                ctx.globalAlpha = 1;
                
                // Draw coordinates
                if (state.showCoords) {
                    const coordsY = subtitleY + subtitleSize + 6 * scale;
                    ctx.font = `400 ${coordsSize}px 'JetBrains Mono', monospace`;
                    ctx.letterSpacing = `${coordsSize * 0.1}px`;
                    ctx.globalAlpha = 0.7;
                    
                    const lat = state.location.lat.toFixed(2);
                    const lng = state.location.lng.toFixed(2);
                    const latDir = state.location.lat >= 0 ? 'N' : 'S';
                    const lngDir = state.location.lng >= 0 ? 'E' : 'W';
                    ctx.fillText(`${Math.abs(lat)}¬∞ ${latDir}, ${Math.abs(lng)}¬∞ ${lngDir}`, textX, coordsY);
                    ctx.globalAlpha = 1;
                }
                
                // Draw date if enabled
                if (state.showDate && state.dateValue) {
                    const dateY = subtitleY + subtitleSize + coordsSize + 16 * scale;
                    ctx.font = `500 ${dateSize}px 'DM Sans', sans-serif`;
                    ctx.letterSpacing = `${dateSize * 0.15}px`;
                    ctx.globalAlpha = 0.85;
                    ctx.fillText(state.dateValue.toUpperCase(), textX, dateY);
                    ctx.globalAlpha = 1;
                }
                
                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;
                
                // Draw frame LAST - in the margin area OUTSIDE the map
                if (state.frameStyle !== 'none') {
                    ctx.strokeStyle = state.frameColor;
                    
                    // Frame is drawn in the margin, outside the map area
                    // Offset from poster edge (into margin area)
                    const marginSize = mapX; // The margin is mapX pixels wide
                    const frameInset = marginSize * 0.4; // Frame sits 40% into the margin from edge
                    
                    let frameBorderWidth = 2 * scale;
                    if (state.frameStyle === 'thick') {
                        frameBorderWidth = 4 * scale;
                    } else if (state.frameStyle === 'double') {
                        frameBorderWidth = 3 * scale;
                    } else if (state.frameStyle === 'vintage' || state.frameStyle === 'ornate') {
                        frameBorderWidth = 3 * scale;
                    }
                    
                    ctx.lineWidth = frameBorderWidth;
                    
                    // Main frame - drawn OUTSIDE the map, in the margin
                    ctx.strokeRect(
                        frameInset,
                        frameInset,
                        posterWidth - frameInset * 2,
                        posterHeight - frameInset * 2
                    );
                    
                    // Double frame - add second line closer to edge
                    if (state.frameStyle === 'double') {
                        ctx.lineWidth = 1 * scale;
                        const innerInset = frameInset + 6 * scale;
                        ctx.strokeRect(
                            innerInset,
                            innerInset,
                            posterWidth - innerInset * 2,
                            posterHeight - innerInset * 2
                        );
                    }
                    
                    // Vintage/ornate - add decorative lines
                    if (state.frameStyle === 'vintage' || state.frameStyle === 'ornate') {
                        ctx.lineWidth = 1 * scale;
                        const innerInset = frameInset + 8 * scale;
                        ctx.strokeRect(
                            innerInset,
                            innerInset,
                            posterWidth - innerInset * 2,
                            posterHeight - innerInset * 2
                        );
                    }
                }
                
                loading.querySelector('.loading-text').textContent = 'Genererer fil...';
                
                // Download
                const link = document.createElement('a');
                link.download = `stedskart-${state.location.name.toLowerCase()}-${posterWidth}x${posterHeight}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                loading.classList.remove('active');
                showNotification(`Eksportert ${posterWidth}√ó${posterHeight}px i print-kvalitet!`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                loading.classList.remove('active');
                
                if (error.message.includes('API')) {
                    showNotification('API-feil: Sjekk at API-n√∏kkelen er korrekt', 'error');
                } else {
                    showNotification('Det oppstod en feil ved eksport. Pr√∏v igjen.', 'error');
                }
            }
        }

        // Simple export without API (lower quality but works without key)
        async function exportSimple() {
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            loading.querySelector('.loading-text').textContent = 'Forbereder rask eksport...';

            try {
                const poster = document.getElementById('posterFrame');
                const originalTransform = poster.style.transform;
                poster.style.transform = 'none';
                
                map.invalidateSize();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                loading.querySelector('.loading-text').textContent = 'Genererer bilde...';
                
                loading.classList.remove('active');
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvas = await html2canvas(poster, {
                    scale: state.exportScale,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: state.bgColor,
                    logging: false,
                    imageTimeout: 30000
                });

                poster.style.transform = originalTransform;
                
                const width = canvas.width;
                const height = canvas.height;

                const link = document.createElement('a');
                link.download = `stedskart-${state.location.name.toLowerCase()}-${width}x${height}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                showNotification(`Eksportert ${width}√ó${height}px (bruk API for h√∏yere kvalitet)`, 'success');
                
            } catch (error) {
                console.error('Simple export error:', error);
                loading.classList.remove('active');
                showNotification('Det oppstod en feil ved eksport.', 'error');
            }
        }

        async function copyToClipboard() {
            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');
            loading.querySelector('.loading-text').textContent = 'Forbereder kopi...';

            try {
                const poster = document.getElementById('posterFrame');
                const originalTransform = poster.style.transform;
                poster.style.transform = 'none';
                
                map.invalidateSize();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                loading.classList.remove('active');
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvas = await html2canvas(poster, {
                    scale: state.exportScale,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: state.bgColor,
                    logging: false,
                    imageTimeout: 30000
                });

                poster.style.transform = originalTransform;
                
                const width = canvas.width;
                const height = canvas.height;

                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showNotification(`Kopiert ${width}√ó${height}px til utklippstavle!`, 'success');
                    } catch (err) {
                        console.error('Clipboard error:', err);
                        showNotification('Kunne ikke kopiere. Pr√∏v √• laste ned i stedet.', 'error');
                    }
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Copy error:', error);
                showNotification('Det oppstod en feil. Pr√∏v igjen.', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                padding: 14px 24px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                border-radius: var(--radius-md);
                font-weight: 500;
                font-size: 14px;
                box-shadow: var(--shadow-lg);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function shareDesign() {
            if (navigator.share) {
                try {
                    const poster = document.getElementById('posterFrame');
                    const canvas = await html2canvas(poster, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: state.bgColor,
                        logging: false
                    });
                    
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], `stedskart-${state.location.name}.png`, { type: 'image/png' });
                        try {
                            await navigator.share({
                                title: `Stedskart: ${state.location.name}`,
                                text: `Sjekk ut denne vakre kartplakaten av ${state.location.name}! Lag din egen p√• Stedskart.`,
                                files: [file]
                            });
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                fallbackShare();
                            }
                        }
                    }, 'image/png');
                } catch (error) {
                    fallbackShare();
                }
            } else {
                fallbackShare();
            }
        }

        function fallbackShare() {
            copyToClipboard();
            showNotification('Bildet er kopiert - lim inn for √• dele!', 'success');
        }

        // Info Modal functions
        function openInfoModal() {
            document.getElementById('infoModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeInfoModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('infoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // Close modal on Escape
            if (e.key === 'Escape') {
                closeInfoModal();
                return;
            }
            
            switch(e.key) {
                case '+':
                case '=':
                    zoomMap(1);
                    break;
                case '-':
                    zoomMap(-1);
                    break;
                case 'r':
                case 'R':
                    if (!e.metaKey && !e.ctrlKey) resetMap();
                    break;
                case 'e':
                case 'E':
                    if (!e.metaKey && !e.ctrlKey) exportPoster('png');
                    break;
                case 'c':
                case 'C':
                    if (!e.metaKey && !e.ctrlKey) copyToClipboard();
                    break;
                case 'i':
                case 'I':
                    if (!e.metaKey && !e.ctrlKey) openInfoModal();
                    break;
                case 's':
                case 'S':
                    if (e.metaKey || e.ctrlKey) {
                        e.preventDefault();
                        exportPoster('png');
                    }
                    break;
            }
        });
    </script>
</body>
</html>
